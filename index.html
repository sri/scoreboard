<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
<title>Scoreboard</title>
<style type="text/css">
html, body, .box, .button {
  font-family: 'Roboto Mono', serif;
  background: #100e17;
}
.score {
  font-size: 180pt;
  text-align: center;
  border: 1px solid #4a4a4a;

}
.teamname {
  text-align: center;
  font-size: 24pt;
  text-transform: uppercase;
}

.gameclock {
  color: #b42a18;
  font-size: 54pt;
  text-align: center;
}
.shotclock {
  color: #b42a18;
  font-size: 44pt;
  text-align: center;
}
.period {
  text-align: center;
  font-size: 32pt;
}
.twopointer, .threepointer {
  border: 0;
  border-radius: 0;
  border: 1px solid #4a4a4a;
}
.paused {
  border: 1px solid #b42a18;
}
</style>
<script type="text/javascript">
var MINS_PER_QUARTER = 4;
var MINS_PER_OVERTIME = 2;

function asInt(elt) {
  const value = parseInt(elt.innerHTML, 10);
  if (isNaN(value)) {
    return 0;
  }
  return value;
}

class Team {
  constructor(eltName) {
    this.elt = document.querySelector(eltName);
    this.scoreElt = this.elt.querySelector(".score");
  }

  getCurrentScore() {
    return asInt(this.scoreElt);
  }

  threePointer(event) {
    if (event) event.preventDefault();
    this.incrementScore(3);

  }

  twoPointer(event) {
    if (event) event.preventDefault();
    this.incrementScore(2);
  }

  onePointer(event) {
    if (event) event.preventDefault();
    this.incrementScore(1);
  }

  incrementScore(n) {
    let currentScore = asInt(this.scoreElt);
    currentScore += n;
    CLOCK.scoreUpdatedCallback();
    this.scoreElt.innerHTML = currentScore + "";
  }
}

class Clock {
  constructor(eltName) {
    this.elt = document.querySelector(eltName);
    this.shotclockElt = this.elt.querySelector(".shotclock");

    this.gameClockElt = this.elt.querySelector(".gameclock");
    this.gameClockMinsElt = this.gameClockElt.querySelector(".mins");
    this.gameClockSecsElt = this.gameClockElt.querySelector(".secs");

    this.quarterElt = this.elt.querySelector(".quarter");
    this.quarterCurrentElt = this.quarterElt.querySelector(".current");
    this.overtimeElt = this.elt.querySelector(".overtime");
    this.overtimeCurrentElt = this.overtimeElt.querySelector(".current");

    this.paused = true;

    this.scoreUpdated = false;
  }

  togglePause(event) {
    if (event) event.preventDefault();

    this.paused = !this.paused;
    if (this.paused) {
      this.elt.classList.add("paused")
    } else {
      this.elt.classList.remove("paused")
    }
  }

  scoreUpdatedCallback() {
    this.scoreUpdated = true;
  }

  updateClock() {
    let mins = asInt(this.gameClockMinsElt);
    let secs = asInt(this.gameClockSecsElt);

    secs -= 1;

    let shotclock = asInt(this.shotclockElt);
    if (mins === 0 && secs <= 24) {
      // If game clock < 24, don't show shot clock.
      shotclock = "-";
    } else if (this.scoreUpdated) {
      shotclock = 24;
      this.scoreUpdated = false;
    } else {
      shotclock -= 1;
    }
    if (shotclock < 0) {
      shotclock = 24;
    }
    this.shotclockElt.innerHTML = shotclock;

    if (secs < 0) {
      mins -= 1;
      secs = 59;
    }
    if (mins < 0) {
      let quarter = asInt(this.quarterCurrentElt);
      if (quarter < 4) {
        quarter += 1;
        mins = MINS_PER_QUARTER;
        secs = 0;
        this.quarterCurrentElt.innerHTML = quarter;
      } else if (HOME.getCurrentScore() === AWAY.getCurrentScore()) {
        // Overtime
        this.quarterElt.classList.add("hidden");
        this.overtimeElt.classList.remove("hidden");

        let overtime = asInt(this.overtimeCurrentElt) + 1;
        mins = MINS_PER_OVERTIME;
        secs = 0;
        this.overtimeCurrentElt.innerHTML = overtime;
      } else {
        // Game over -- we don't stop the interval that keeps
        // calling this method. If score at some point becomes the same,
        // overtime starts (buzzer beater occurs, and a few seconds later,
        // after a "review", score is incremented).
        return;
      }
    }

    this.gameClockMinsElt.innerHTML = this.format2digit(mins);
    this.gameClockSecsElt.innerHTML = this.format2digit(secs);
  }

  format2digit(n) {
    if (n < 10) return '0' + n;
    return n;
  }

  update() {
    if (!this.paused) {
      this.updateClock();
    }
  }

  init() {
    setInterval(() => this.update(), 1000);
  }
}

let CLOCK,
    HOME,
    AWAY;

function Init() {
  HOME = new Team(".hometeam");
  AWAY = new Team(".awayteam");

  CLOCK = new Clock(".clock");
  CLOCK.init();

  window.addEventListener("beforeunload", function (e) {
    var confirmationMessage = 'If you leave, your game will be lost.';
    (e || window.event).returnValue = confirmationMessage; //Gecko + IE
    return confirmationMessage; //Gecko + Webkit, Safari, Chrome etc.
  });
}

</script>
</head>
<body onload="Init()">
  <div class="columns is-gapless is-vcentered">
    <div class="column is-one-third hometeam">
      <div class="tile is-ancestor">
        <div class="tile is-vertical is-parent">
          <div class="tile is-child">
            <div class="teamname">Portland Trail Blazers</div>
          </div>
          <div class="tile is-child">
            <div class="score" onTouchStart="HOME.onePointer(event)" onClick="HOME.onePointer()">0</div>
          </div>
          <div class="tile is-parent">
            <div class="tile is-child">
              <a class="button is-large is-fullwidth twopointer" onTouchStart="HOME.twoPointer(event)" onClick="HOME.twoPointer()">
                +2pt
              </a>
            </div>
            <div class="tile is-child">
              <a class="button is-large is-fullwidth threepointer" onTouchStart="HOME.threePointer(event)" onClick="HOME.threePointer()">
                +3pt
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="column is-one-third clock paused" onTouchStart="CLOCK.togglePause(event)" onclick="CLOCK.togglePause()">
      <div class="tile is-ancestor">
        <div class="tile is-vertical is-parent">
          <div class="tile is-child">
            <div class="gameclock">
              <span class="mins">4</span>:<span class="secs">00</span>
            </div>
          </div>
          <div class="tile is-child">
            <div class="shotclock">
              24
            </div>
          </div>
          <div class="tile is-child period">
            <div class="quarter">Quarter <span class="current">1</span></div>
            <div class="overtime is-hidden">Overtime <span class="current">0</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="column is-one-third awayteam">
      <div class="tile is-ancestor">
        <div class="tile is-vertical is-parent">
          <div class="tile is-child">
            <div class="teamname">Los Angeles Lakers</div>
          </div>
          <div class="tile is-child">
            <div class="score" onTouchStart="AWAY.onePointer(event)" onClick="AWAY.onePointer()">0</div>
          </div>
          <div class="tile is-parent">
            <div class="tile is-child">
              <a class="button is-large is-fullwidth twopointer" onTouchStart="AWAY.twoPointer(event)" onClick="AWAY.twoPointer()">
                +2pt
              </a>
            </div>
            <div class="tile is-child">
              <a class="button is-large is-fullwidth threepointer" onTouchStart="AWAY.threePointer(event)" onClick="AWAY.threePointer()">
                +3pt
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
